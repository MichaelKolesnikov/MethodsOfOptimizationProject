# Работа №7
## Метод ветвей и границ решения задачи коммвояжера
Дано n городов, $\large C = \left| c_{i,j} \right|, \quad i, j = \overline{1, n}$ - матрица стоимостей переездов из $i$-х городов в $j$-е. Коммивояжер должен выехать из своего города, заехать в каждый город только один раз и вернуться в исходный город. Нужно найти замкнутый маршрут объезда всех городов минимальной стоимости.
$$
\large
\begin{aligned}
& x_{i,j} = \begin{cases} 1, \text{если коммивояжер едет из i в j} \\ 0, \text{иначе} \\ \end{cases}
\qquad F=\sum_{i=1}^n \sum_{j=1}^n c_{i.j} \cdot x_{i,j} \rightarrow min \\
& \sum_{i=1}^n x_{i,j} = 1 \ \forall j=\overline{1,n}, \qquad
\sum_{j=1}^n x_{i,j} = 1 \ \forall i=\overline{1,n} \\
\end{aligned}
$$
Из каждого i-го города только один выезд, в каждый j-й город, только один въезд.
$\large u_i \in \overline{1,n}$ - каким по счету мы посетим город i.
$\large u_i-u_j + n \cdot x_{i,j} \leq n - 1$ - обеспечивает замкнутость маршрута и отсутствие петель
### Решение программой
```python
import random  
  
class TSPSolver:  
    def __init__(self, matrix):  
        self.n = len(matrix)  
        self.graph = matrix  
        self.best_cost = float('inf')  
        self.best_path = []  
  
    def solve(self):  
        visited = [False] * self.n  
        visited[0] = True  
        self._branch_and_bound(0, visited, 1, 0, [0])  
        return self.best_cost, self.best_path  
  
    def _branch_and_bound(self, curr_node, visited, level, curr_cost, path):  
        if level == self.n:  
            return_cost = self.graph[curr_node][0]  
            if return_cost > 0:  
                total_cost = curr_cost + return_cost  
                if total_cost < self.best_cost:  
                    self.best_cost = total_cost  
                    self.best_path = path + [0]  
            return  
  
        for i in range(self.n):  
            if not visited[i] and self.graph[curr_node][i] > 0:  
                next_cost = curr_cost + self.graph[curr_node][i]  
                if next_cost < self.best_cost:  
                    visited[i] = True  
                    self._branch_and_bound(i, visited, level + 1, next_cost, path + [i])  
                    visited[i] = False  
  
def input_matrix(n):  
    print(f"Введите матрицу размера {n} x {n} (через пробелы, элементы разделяются строками):")  
    matrix = []  
    for i in range(n):  
        row = list(map(int, input().split()))  
        matrix.append(row)  
    return matrix  
  
def generate_random_matrix(n, max_weight=100):  
    matrix = [[random.randint(1, max_weight) if i != j else 0 for j in range(n)] for i in range(n)]  
    return matrix  
  
def print_matrix(matrix):  
    for row in matrix:  
        print(" ".join(map(str, row)))  
  
def main():  
    n = int(input("Введите размер матрицы (n): "))  
    print("Выберите опцию:")  
    print("1. Ввести свою матрицу")  
    print("2. Сгенерировать случайную матрицу")  
    option = int(input("Ваш выбор (1 или 2): "))  
  
    if option == 1:  
        matrix = input_matrix(n)  
    elif option == 2:  
        matrix = generate_random_matrix(n)  
        print("Сгенерированная матрица:")  
        print_matrix(matrix)  
    else:  
        print("Некорректный выбор.")  
        return  
  
    solver = TSPSolver(matrix)  
    cost, path = solver.solve()  
    print("\nМинимальная стоимость:", cost)  
    print("Оптимальный путь:", " -> ".join(map(str, path)))  
  
if __name__ == "__main__":  
    main()
```
Работа программы:
```
Введите размер матрицы (n): 10
Выберите опцию:
1. Ввести свою матрицу
2. Сгенерировать случайную матрицу
Ваш выбор (1 или 2): 2
Сгенерированная матрица:
0 34 68 18 63 80 12 44 58 87
56 0 56 94 62 65 18 38 67 22
34 53 0 91 13 73 70 51 13 37
28 19 14 0 83 89 25 9 89 22
67 13 1 19 0 51 7 13 31 4
3 78 24 90 14 0 77 6 35 69
96 32 100 4 8 19 0 26 37 36
79 2 48 25 63 99 17 0 44 45
97 49 33 74 23 72 23 73 0 87
58 83 24 39 17 76 64 78 100 0

Минимальная стоимость: 127
Оптимальный путь: 0 -> 3 -> 7 -> 1 -> 9 -> 4 -> 2 -> 8 -> 6 -> 5 -> 0
```
### Решение руками
**Задача коммивояжера**.  
Возьмем в качестве произвольного маршрута:  
X0 = (1,2);(2,3);(3,4);(4,5);(5,6);(6,7);(7,8);(8,9);(9,10);(10,1)  
Тогда F(X0) = 34 + 56 + 91 + 83 + 51 + 77 + 26 + 44 + 87 + 58 = 607  
Для определения нижней границы множества воспользуемся **операцией редукции** или приведения матрицы по строкам, для чего необходимо в каждой строке матрицы D найти минимальный элемент.  
di = min(j) dij  
Затем вычитаем di из элементов рассматриваемой строки. В связи с этим во вновь полученной матрице в каждой строке будет как минимум один ноль.  
Такую же операцию редукции проводим по столбцам, для чего в каждом столбце находим минимальный элемент:  
dj = min(i) dij  
  
После вычитания минимальных элементов получаем полностью редуцированную матрицу, где величины di и dj называются **константами приведения**.  

|         |       |       |       |       |       |       |       |       |       |        |
| ------- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ----- | ------ |
| **i j** | **1** | **2** | **3** | **4** | **5** | **6** | **7** | **8** | **9** | **10** |
| **1**   | M     | 22    | 56    | 6     | 51    | 53    | 0     | 32    | 46    | 72     |
| **2**   | 38    | M     | 38    | 76    | 44    | 32    | 0     | 20    | 49    | 1      |
| **3**   | 21    | 40    | M     | 78    | 0     | 45    | 57    | 38    | 0     | 21     |
| **4**   | 19    | 10    | 5     | M     | 74    | 65    | 16    | 0     | 80    | 10     |
| **5**   | 66    | 12    | 0     | 18    | M     | 35    | 6     | 12    | 30    | 0      |
| **6**   | 0     | 75    | 21    | 87    | 11    | M     | 74    | 3     | 32    | 63     |
| **7**   | 92    | 28    | 96    | 0     | 4     | 0     | M     | 22    | 33    | 29     |
| **8**   | 77    | 0     | 46    | 23    | 61    | 82    | 15    | M     | 42    | 40     |
| **9**   | 74    | 26    | 10    | 51    | 0     | 34    | 0     | 50    | M     | 61     |
| **10**  | 41    | 66    | 7     | 22    | 0     | 44    | 47    | 61    | 83    | M      |

Сумма констант приведения определяет нижнюю границу H:  
H = ∑di + ∑dj  
H = 12+18+13+9+1+3+4+2+23+17+0+0+0+0+0+15+0+0+0+3 = 120  
**Шаг №1**.  
**Определяем ребро ветвления** и разобьем все множество маршрутов относительно этого ребра на два подмножества (i,j) и (i*,j*).  
С этой целью для всех клеток матрицы с нулевыми элементами заменяем поочередно нули на М(бесконечность) и определяем для них сумму образовавшихся констант приведения, они приведены в скобках.  

d(1,7) = 6 + 0 = 6; d(2,7) = 1 + 0 = 1; d(3,5) = 0 + 0 = 0; d(3,9) = 0 + 30 = 30; d(4,8) = 5 + 3 = 8; d(5,3) = 0 + 5 = 5; d(5,10) = 0 + 1 = 1; d(6,1) = 3 + 19 = 22; d(7,4) = 0 + 6 = 6; d(7,6) = 0 + 32 = 32; d(8,2) = 15 + 10 = 25; d(9,5) = 0 + 0 = 0; d(9,7) = 0 + 0 = 0; d(10,5) = 7 + 0 = 7;  
Наибольшая сумма констант приведения равна (0 + 32) = 32 для ребра (7,6), следовательно, множество разбивается на два подмножества (7,6) и (7*,6*).  
**Исключение ребра** (7,6) проводим путем замены элемента d76 = 0 на M, после чего осуществляем очередное приведение матрицы расстояний для образовавшегося подмножества (7*,6*), в результате получим редуцированную матрицу.  

|   |   |   |   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|---|---|---|
|**i j**|**1**|**2**|**3**|**4**|**5**|**6**|**7**|**8**|**9**|**10**|di|
|**1**|M|22|56|6|51|53|0|32|46|72|0|
|**2**|38|M|38|76|44|32|0|20|49|1|0|
|**3**|21|40|M|78|0|45|57|38|0|21|0|
|**4**|19|10|5|M|74|65|16|0|80|10|0|
|**5**|66|12|0|18|M|35|6|12|30|0|0|
|**6**|0|75|21|87|11|M|74|3|32|63|0|
|**7**|92|28|96|0|4|M|M|22|33|29|0|
|**8**|77|0|46|23|61|82|15|M|42|40|0|
|**9**|74|26|10|51|0|34|0|50|M|61|0|
|**10**|41|66|7|22|0|44|47|61|83|M|0|
|dj|0|0|0|0|0|32|0|0|0|0|32|

Нижняя граница гамильтоновых циклов этого подмножества:  
H(7*,6*) = 120 + 32 = 152  
**Включение ребра** (7,6) проводится путем исключения всех элементов 7-ой строки и 6-го столбца, в которой элемент d67 заменяем на М, для исключения образования негамильтонова цикла.  
В результате получим другую сокращенную матрицу (9 x 9), которая подлежит операции приведения.  
После операции приведения сокращенная матрица будет иметь вид:  

|   |   |   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|---|---|
|**i j**|**1**|**2**|**3**|**4**|**5**|**7**|**8**|**9**|**10**|di|
|**1**|M|22|56|6|51|0|32|46|72|0|
|**2**|38|M|38|76|44|0|20|49|1|0|
|**3**|21|40|M|78|0|57|38|0|21|0|
|**4**|19|10|5|M|74|16|0|80|10|0|
|**5**|66|12|0|18|M|6|12|30|0|0|
|**6**|0|75|21|87|11|M|3|32|63|0|
|**8**|77|0|46|23|61|15|M|42|40|0|
|**9**|74|26|10|51|0|0|50|M|61|0|
|**10**|41|66|7|22|0|47|61|83|M|0|
|dj|0|0|0|6|0|0|0|0|0|6|

Сумма констант приведения сокращенной матрицы:  
∑di + ∑dj = 6  
Нижняя граница подмножества (7,6) равна:  
H(7,6) = 120 + 6 = 126 ≤ 152  
Поскольку нижняя граница этого подмножества (7,6) меньше, чем подмножества (7*,6*), то ребро (7,6) включаем в маршрут с новой границей H = 126.  
**Шаг №2**.  
**Определяем ребро ветвления**.  
  
d(1,4) = 0 + 12 = 12; d(1,7) = 0 + 0 = 0; d(2,7) = 1 + 0 = 1; d(3,5) = 0 + 0 = 0; d(3,9) = 0 + 30 = 30; d(4,8) = 5 + 3 = 8; d(5,3) = 0 + 5 = 5; d(5,10) = 0 + 1 = 1; d(6,1) = 3 + 19 = 22; d(8,2) = 15 + 10 = 25; d(9,5) = 0 + 0 = 0; d(9,7) = 0 + 0 = 0; d(10,5) = 7 + 0 = 7;  
max: d(3,9)=30.  
**Исключение ребра** (3,9): d39=M.  

|   |   |   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|---|---|
|**i j**|**1**|**2**|**3**|**4**|**5**|**7**|**8**|**9**|**10**|di|
|**1**|M|22|56|0|51|0|32|46|72|0|
|**2**|38|M|38|70|44|0|20|49|1|0|
|**3**|21|40|M|72|0|57|38|M|21|0|
|**4**|19|10|5|M|74|16|0|80|10|0|
|**5**|66|12|0|12|M|6|12|30|0|0|
|**6**|0|75|21|81|11|M|3|32|63|0|
|**8**|77|0|46|17|61|15|M|42|40|0|
|**9**|74|26|10|45|0|0|50|M|61|0|
|**10**|41|66|7|16|0|47|61|83|M|0|
|dj|0|0|0|0|0|0|0|30|0|30|
 H(3*,9*) = 126 + 30 = 156  
**Включение ребра** (3,9): d93=М.  

|   |   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|---|
|**i j**|**1**|**2**|**3**|**4**|**5**|**7**|**8**|**10**|di|
|**1**|M|22|56|0|51|0|32|72|0|
|**2**|38|M|38|70|44|0|20|1|0|
|**4**|19|10|5|M|74|16|0|10|0|
|**5**|66|12|0|12|M|6|12|0|0|
|**6**|0|75|21|81|11|M|3|63|0|
|**8**|77|0|46|17|61|15|M|40|0|
|**9**|74|26|M|45|0|0|50|61|0|
|**10**|41|66|7|16|0|47|61|M|0|
|dj|0|0|0|0|0|0|0|0|0|
∑di + ∑dj = 0  
H(3,9) = 126 + 0 = 126 ≤ 156  
Ребро (3,9) включаем в маршрут с новой границей H=126.  
**Шаг №3**.  
**Определяем ребро ветвления**.  
d(1,4) = 0 + 12 = 12; d(1,7) = 0 + 0 = 0; d(2,7) = 1 + 0 = 1; d(4,8) = 5 + 3 = 8; d(5,3) = 0 + 5 = 5; d(5,10) = 0 + 1 = 1; d(6,1) = 3 + 19 = 22; d(8,2) = 15 + 10 = 25; d(9,5) = 0 + 0 = 0; d(9,7) = 0 + 0 = 0; d(10,5) = 7 + 0 = 7;  
max: d(8,2)=25.  
**Исключение ребра** (8,2): d82=M.  

|   |   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|---|
|**i j**|**1**|**2**|**3**|**4**|**5**|**7**|**8**|**10**|di|
|**1**|M|22|56|0|51|0|32|72|0|
|**2**|38|M|38|70|44|0|20|1|0|
|**4**|19|10|5|M|74|16|0|10|0|
|**5**|66|12|0|12|M|6|12|0|0|
|**6**|0|75|21|81|11|M|3|63|0|
|**8**|77|M|46|17|61|15|M|40|15|
|**9**|74|26|M|45|0|0|50|61|0|
|**10**|41|66|7|16|0|47|61|M|0|
|dj|0|10|0|0|0|0|0|0|25|
H(8*,2*) = 126 + 25 = 151  
**Включение ребра** (8,2): d28=М.  

|   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|
|**i j**|**1**|**3**|**4**|**5**|**7**|**8**|**10**|di|
|**1**|M|56|0|51|0|32|72|0|
|**2**|38|38|70|44|0|M|1|0|
|**4**|19|5|M|74|16|0|10|0|
|**5**|66|0|12|M|6|12|0|0|
|**6**|0|21|81|11|M|3|63|0|
|**9**|74|M|45|0|0|50|61|0|
|**10**|41|7|16|0|47|61|M|0|
|dj|0|0|0|0|0|0|0|0|
  
∑di + ∑dj = 0  
H(8,2) = 126 + 0 = 126 ≤ 151  
Ребро (8,2) включаем в маршрут с новой границей H=126.  
**Шаг №4**.  
**Определяем ребро ветвления**.  

d(1,4) = 0 + 12 = 12; d(1,7) = 0 + 0 = 0; d(2,7) = 1 + 0 = 1; d(4,8) = 5 + 3 = 8; d(5,3) = 0 + 5 = 5; d(5,10) = 0 + 1 = 1; d(6,1) = 3 + 19 = 22; d(9,5) = 0 + 0 = 0; d(9,7) = 0 + 0 = 0; d(10,5) = 7 + 0 = 7;  
max: d(6,1)=22.  
**Исключение ребра** (6,1): d61=M.  

|   |   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|---|
|**i j**|**1**|**3**|**4**|**5**|**7**|**8**|**10**|di|
|**1**|M|56|0|51|0|32|72|0|
|**2**|38|38|70|44|0|M|1|0|
|**4**|19|5|M|74|16|0|10|0|
|**5**|66|0|12|M|6|12|0|0|
|**6**|M|21|81|11|M|3|63|3|
|**9**|74|M|45|0|0|50|61|0|
|**10**|41|7|16|0|47|61|M|0|
|dj|19|0|0|0|0|0|0|22|
 
H(6*,1*) = 126 + 22 = 148  
**Включение ребра** (6,1): d16=М.  

|   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|
|**i j**|**3**|**4**|**5**|**7**|**8**|**10**|di|
|**1**|56|0|51|0|32|72|0|
|**2**|38|70|44|0|M|1|0|
|**4**|5|M|74|16|0|10|0|
|**5**|0|12|M|6|12|0|0|
|**9**|M|45|0|0|50|61|0|
|**10**|7|16|0|47|61|M|0|
|dj|0|0|0|0|0|0|0|
  
∑di + ∑dj = 0  
H(6,1) = 126 + 0 = 126 ≤ 148  
Запрещаем переходы: (1,7),  
Ребро (6,1) включаем в маршрут с новой границей H=126.  
**Шаг №5**.  
**Определяем ребро ветвления**.  

d(1,4) = 32 + 12 = 44; d(2,7) = 1 + 0 = 1; d(4,8) = 5 + 12 = 17; d(5,3) = 0 + 5 = 5; d(5,10) = 0 + 1 = 1; d(9,5) = 0 + 0 = 0; d(9,7) = 0 + 0 = 0; d(10,5) = 7 + 0 = 7;  
max: d(1,4)=44.  
**Исключение ребра** (1,4): d14=M.  

|   |   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|---|
|**i j**|**3**|**4**|**5**|**7**|**8**|**10**|di|
|**1**|56|M|51|M|32|72|32|
|**2**|38|70|44|0|M|1|0|
|**4**|5|M|74|16|0|10|0|
|**5**|0|12|M|6|12|0|0|
|**9**|M|45|0|0|50|61|0|
|**10**|7|16|0|47|61|M|0|
|dj|0|12|0|0|0|0|44|
  
H(1*,4*) = 126 + 44 = 170  
**Включение ребра** (1,4): d41=М.  

|   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|
|**i j**|**3**|**5**|**7**|**8**|**10**|di|
|**2**|38|44|0|M|1|0|
|**4**|5|74|16|0|10|0|
|**5**|0|M|6|12|0|0|
|**9**|M|0|0|50|61|0|
|**10**|7|0|47|61|M|0|
|dj|0|0|0|0|0|0|
  
∑di + ∑dj = 0  
H(1,4) = 126 + 0 = 126 ≤ 170  
Запрещаем переходы: (4,7), (4,6),  
Ребро (1,4) включаем в маршрут с новой границей H=126.  
**Шаг №6**.  
**Определяем ребро ветвления**.  
 
d(2,7) = 1 + 0 = 1; d(4,8) = 5 + 12 = 17; d(5,3) = 0 + 5 = 5; d(5,10) = 0 + 1 = 1; d(9,5) = 0 + 0 = 0; d(9,7) = 0 + 0 = 0; d(10,5) = 7 + 0 = 7;  
max: d(4,8)=17.  
**Исключение ребра** (4,8): d48=M.  

|   |   |   |   |   |   |   |
|---|---|---|---|---|---|---|
|**i j**|**3**|**5**|**7**|**8**|**10**|di|
|**2**|38|44|0|M|1|0|
|**4**|5|74|M|M|10|5|
|**5**|0|M|6|12|0|0|
|**9**|M|0|0|50|61|0|
|**10**|7|0|47|61|M|0|
|dj|0|0|0|12|0|17|
 
H(4*,8*) = 126 + 17 = 143  
**Включение ребра** (4,8): d84=М.  

|   |   |   |   |   |   |
|---|---|---|---|---|---|
|**i j**|**3**|**5**|**7**|**10**|di|
|**2**|38|44|0|1|0|
|**5**|0|M|6|0|0|
|**9**|M|0|0|61|0|
|**10**|7|0|47|M|0|
|dj|0|0|0|0|0|
  
∑di + ∑dj = 0  
H(4,8) = 126 + 0 = 126 ≤ 143  
Запрещаем переходы: (2,7), (2,6), (2,1), (2,4),  
Ребро (4,8) включаем в маршрут с новой границей H=126.  
**Шаг №7**.  
**Определяем ребро ветвления**.  

|   |   |   |   |   |   |
|---|---|---|---|---|---|
|**i j**|**3**|**5**|**7**|**10**|di|
|**2**|38|44|M|1|0|
|**5**|**0(7)**|M|6|0(1)|0|
|**9**|M|0(0)|0(6)|61|0|
|**10**|7|0(7)|47|M|7|
|dj|7|0|6|1|0|
 
d(5,3) = 0 + 7 = 7; d(5,10) = 0 + 1 = 1; d(9,5) = 0 + 0 = 0; d(9,7) = 0 + 6 = 6; d(10,5) = 7 + 0 = 7;  
max: d(5,3)=7.  
**Исключение ребра** (5,3): d53=M.  

|   |   |   |   |   |   |
|---|---|---|---|---|---|
|**i j**|**3**|**5**|**7**|**10**|di|
|**2**|38|44|M|1|1|
|**5**|M|M|6|0|0|
|**9**|M|0|0|61|0|
|**10**|7|0|47|M|0|
|dj|7|0|0|0|8|
 
H(5*,3*) = 126 + 8 = 134  
**Включение ребра** (5,3): d35=М.  

|   |   |   |   |   |
|---|---|---|---|---|
|**i j**|**5**|**7**|**10**|di|
|**2**|44|M|1|1|
|**9**|0|0|61|0|
|**10**|0|47|M|0|
|dj|0|0|1|2|

∑di + ∑dj = 2  
H(5,3) = 126 + 2 = 128 ≤ 134  
Запрещаем переходы: (2,7), (2,6), (2,1), (2,4), (9,5),  
Ребро (5,3) включаем в маршрут с новой границей H=128.  
**Шаг №8**.  
**Определяем ребро ветвления**.  

|   |   |   |   |   |
|---|---|---|---|---|
|**i j**|**5**|**7**|**10**|di|
|**2**|43|M|0(104)|43|
|**9**|M|**0(108)**|61|61|
|**10**|0(90)|47|M|47|
|dj|43|47|61|0|
d(2,10) = 43 + 61 = 104; d(9,7) = 61 + 47 = 108; d(10,5) = 47 + 43 = 90;  
max: d(9,7)=108.  
**Исключение ребра** (9,7): d97=M.  

|   |   |   |   |   |
|---|---|---|---|---|
|**i j**|**5**|**7**|**10**|di|
|**2**|43|M|0|0|
|**9**|M|M|61|61|
|**10**|0|47|M|0|
|dj|0|47|0|108|
H(9*,7*) = 128 + 108 = 236  
**Включение ребра** (9,7): d79=М.  

|   |   |   |   |
|---|---|---|---|
|**i j**|**5**|**10**|di|
|**2**|43|0|0|
|**10**|0|M|0|
|dj|0|0|0|
∑di + ∑dj = 0  
H(9,7) = 128 + 0 = 128 ≤ 236  
Ребро (9,7) включаем в маршрут с новой границей H=128.  
В соответствии с этой матрицей включаем в гамильтонов маршрут ребра (2,10) и (10,5).  
В результате по дереву ветвлений гамильтонов цикл образуют ребра:  
(7,6), (6,1), (1,4), (4,8), (8,2), (2,10), (10,5), (5,3), (3,9), (9,7),  
Длина маршрута равна F(Mk) = 127

![[Pasted image 20241219230336.png]]